FAIL tests/unit/authorization.service.test.ts (11.615 s)
  AuthorizationService
    checkPermission
      ├ù should return allowed: true when permission is granted by policy (11 ms)
      ├ù should return allowed: false when permission is denied by policy (1 ms)
      ΓêÜ should throw ValidationError if action is missing (13 ms)
      ΓêÜ should throw ValidationError if resource is missing (1 ms)
      ΓêÜ should throw PolicyLoadError if no policies are found (1 ms)
      ├ù should throw PolicyEvaluationError if regoEngine.evaluate throws an error (1 ms)
      ΓêÜ should re-throw PolicyLoadError if caught (1 ms)
      ├ù should re-throw PolicyEvaluationError if caught
      ΓêÜ should re-throw ValidationError if caught (1 ms)
    testPolicy
      ΓêÜ should return the evaluation result for a valid policy test (1 ms)
      ΓêÜ should throw ValidationError if policy string is empty (2 ms)
      ΓêÜ should throw PolicyEvaluationError if regoEngine.evaluate throws an error during testPolicy (1 ms)
      ΓêÜ should re-throw ValidationError if caught during testPolicy (2 ms)

  ΓùÅ AuthorizationService ΓÇ║ checkPermission ΓÇ║ should return allowed: true when permission is granted by policy

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
    -   "allowed": true,
    -   "reason": "Allowed by policy",
    +   "allowed": false,
    +   "reason": "No applicable policy found",
      }

      67 |             const result = await authorizationService.checkPermission(mockPermissionCheck);
      68 |
    > 69 |             expect(result).toEqual({ allowed: true, reason: "Allowed by policy" });
         |                            ^
      70 |             expect(mockLogger.debug).toHaveBeenCalledWith("Checking permission", { check: mockPermissionCheck });
      71 |             expect(mockPolicyRepository.getPolicies).toHaveBeenCalled();
      72 |             expect(mockRegoEngine.evaluate).toHaveBeenCalledWith(

      at tests/unit/authorization.service.test.ts:69:28
      at fulfilled (tests/unit/authorization.service.test.ts:5:58)

  ΓùÅ AuthorizationService ΓÇ║ checkPermission ΓÇ║ should return allowed: false when permission is denied by policy

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 1

      Object {
        "allowed": false,
    -   "reason": "Denied by policy",
    +   "reason": "No applicable policy found",
      }

      91 |             const result = await authorizationService.checkPermission(mockPermissionCheck);
      92 |
    > 93 |             expect(result).toEqual({ allowed: false, reason: "Denied by policy" });
         |                            ^
      94 |             expect(mockLogger.debug).toHaveBeenCalledWith("Checking permission", { check: mockPermissionCheck });
      95 |             expect(mockPolicyRepository.getPolicies).toHaveBeenCalled();
      96 |             expect(mockRegoEngine.evaluate).toHaveBeenCalledWith(

      at tests/unit/authorization.service.test.ts:93:28
      at fulfilled (tests/unit/authorization.service.test.ts:5:58)

  ΓùÅ AuthorizationService ΓÇ║ checkPermission ΓÇ║ should throw PolicyEvaluationError if regoEngine.evaluate throws an error

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"allowed": false, "reason": "No applicable policy found"}

      135 |             mockRegoEngine.evaluate.mockRejectedValue(evaluationError);
      136 |
    > 137 |             await expect(authorizationService.checkPermission(mockPermissionCheck)).rejects.toThrow(PolicyEvaluationError);
          |                   ^
      138 |             await expect(authorizationService.checkPermission(mockPermissionCheck)).rejects.toThrow("Failed to evaluate permission: OPA evaluation failed");
      139 |             expect(mockLogger.error).toHaveBeenCalledWith(
      140 |                 "Error during policy evaluation or data gathering",

      at expect (node_modules/.pnpm/expect@29.7.0/node_modules/expect/build/index.js:113:15)
      at tests/unit/authorization.service.test.ts:137:19
      at tests/unit/authorization.service.test.ts:8:71
      at Object.<anonymous>.__awaiter (tests/unit/authorization.service.test.ts:4:12)
      at Object.<anonymous> (tests/unit/authorization.service.test.ts:132:100)

  ΓùÅ AuthorizationService ΓÇ║ checkPermission ΓÇ║ should re-throw PolicyEvaluationError if caught

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"allowed": false, "reason": "No applicable policy found"}

      152 |             mockPolicyRepository.getPolicies.mockResolvedValue([mockPolicy]);
      153 |             mockRegoEngine.evaluate.mockRejectedValue(new PolicyEvaluationError("Rego error"));
    > 154 |             await expect(authorizationService.checkPermission(mockPermissionCheck)).rejects.toThrow(PolicyEvaluationError);
          |                   ^
      155 |             expect(mockLogger.error).toHaveBeenCalled();
      156 |         });
      157 |

      at expect (node_modules/.pnpm/expect@29.7.0/node_modules/expect/build/index.js:113:15)
      at tests/unit/authorization.service.test.ts:154:19
      at tests/unit/authorization.service.test.ts:8:71
      at Object.<anonymous>.__awaiter (tests/unit/authorization.service.test.ts:4:12)
      at Object.<anonymous> (tests/unit/authorization.service.test.ts:151:74)

---------------------------|---------|----------|---------|---------|-------------------
File                       | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
---------------------------|---------|----------|---------|---------|-------------------
All files                  |   90.95 |    92.85 |   88.88 |   90.95 |                   
 application/services      |   84.15 |     91.3 |     100 |   84.15 |                   
  authorization.service.ts |   84.15 |     91.3 |     100 |   84.15 | 49-62,78-79       
 domain/exceptions         |     100 |      100 |     100 |     100 |                   
  AuthorizationError.ts    |     100 |      100 |     100 |     100 |                   
 shared/constants          |     100 |      100 |     100 |     100 |                   
  types.ts                 |     100 |      100 |     100 |     100 |                   
 shared/errors             |   94.73 |      100 |   66.66 |   94.73 |                   
  BaseError.ts             |   94.73 |      100 |   66.66 |   94.73 | 34-35             
---------------------------|---------|----------|---------|---------|-------------------
Test Suites: 1 failed, 1 total
Tests:       4 failed, 9 passed, 13 total
Snapshots:   0 total
Time:        12.105 s, estimated 15 s
Ran all test suites matching /tests\\unit\\authorization.service.test.ts/i.
